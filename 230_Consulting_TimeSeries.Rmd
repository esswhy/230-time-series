---
title: "PSTAT 230: Time Series Consulting"
author: "Selin Karabulut, Sophia Arabadjis, Shuying Yu"
date: "4/27/2021"
output: 
  html_document:
    df_print: paged
    theme: flatly
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
bibliography: refs_file.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


# An intuition for time series and data analysis in R


We are using an example data set used in the Appendix by @shumway_time_2017. Examples for code using `R` to explore time series data is also found in @hyndman_forecasting_nodate. 


Time series data can be thought of as data consistently measured or observed at different points in time. In this way, the data have an implicit \textit{order} or flow, and questions about time series data often involve questions about change over time. 

```{r}
#Libraries
library(tidyverse)
library(lubridate)
library(PerformanceAnalytics)
library(Hmisc)
library(astsa)

# Load data sets
data("cmort")
data("part")
cmort <- cmort
part <- part
paste("Particulate Matter Data", paste(head(part), collapse = " "))
paste("Cardiac Mortality Data", paste(head(cmort),collapse = " "))
```

In this case, we know that the data comes from the average weekly cardiovascular mortality in Los Angeles County. We can instruct the `R` to read and format that data in that way using `ts(data, start=(),frequency)` arguments, where in the `start` we dictate the year and week of the data start, and the frequency specifies how many weeks (52) to consider. Using '`ts` objects is very handy because we don't have to store and manipulate dates (if they are regular interval), and visualization becomes easier.

```{r}
cmort.ts <- ts(cmort, start = c(1970,1),frequency = 52)
cmort.ts
part.ts <- ts(part, start = c(1970,1), frequency = 52)
part.ts
```

For the particulate matter data set, we know this data set comes from the LA pollution study and is measured from 1970 through 1980, weekly.

```{r, df_print}
#Set figure parameters
layout(matrix(c(1:2, 1:2), ncol=2), height=c(.5,.5)) 
par(mar=c(.2,2,0,.5), oma=c(3.2,3,2.5,0), las=1)

#Particulate matter
plot(part.ts, type='n', xaxt='no', ylab='PM Conc.')
grid(lty=1, col=gray(.9))
lines(part.ts, col = "cadetblue3")

#Cardiovascular mortality
plot(cmort.ts, type='n', ylab='Cardiac Mortality')
grid(lty=1, col=gray(.9))
lines(cmort.ts, col="orange3")

#Labels
mtext(side=1, "Year", line=2)
title(main = "PM Concentration & Cardiovascular Mortality", outer = T)
```

The top figure illustrates the particulate matter rate (blue) while the bottom graph illustrates the cardiovascular mortality rate (orange) from the years 1970 through 1980. In this case, we are interested in analyzing two time series at once. Both series exhibit periodicity or repetitive cycles that are visible and somewhat similar: both show peaks in values every year (e.g., 1970, 1971, 1972, etc.). This also indicates that the two series are related, such that cardiovascular mortality rate is dependent on particulate matter rate in LA County.



# Exploratory data analysis for time series data in R

To measure dependence, we can use an **autocorrelation function (ACF)** in a time series model. ACF measures the linear predictability of the time series at time *t* using only its adjacent value at time *s* [@shumway_time_2006]. This can be done by using a linear combination of inputs. Thus, ACF provides the ability to forecast the series at time *t* from the value at time *s*. 

What we also can do is plot the temperature data as another series to observe how particulate matter and cardiovascular mortality covary.

```{r}
#Add temperature data
data("tempr")
tempr <- tempr
temp.ts <- ts(tempr, start = c(1970,1), frequency = 52)


#Set figure parameters
layout(matrix(c(1:3, 1:3), ncol=2), height=c(.5,.5, .5)) 
par(mar=c(.2,2,0,.5), oma=c(3.2,3,2.5,0), las=1)

#Particulate matter
plot(part.ts, type='n', xaxt='no', ylab='PM Conc.')
grid(lty=1, col=gray(.9))
lines(part.ts, col = "cadetblue3")

#Cardiovascular mortality
plot(cmort.ts, type='n', xaxt='no', ylab='Cardiac Mortality')
grid(lty=1, col=gray(.9))
lines(cmort.ts, col="orange3")

#Temperature
plot(temp.ts, type='n', ylab="Temperature")
grid(lty=1, col=gray(.9))
lines(temp.ts, col="red")

#Labels
mtext(side=1, "Year", line=2)
title(main = "Particulate Concentration, Cardiovascular Mortality, and Temperature", outer = T)
```

Note the strong seasonal components in all of the series, corresponding to winter-summer variations and the downward trend in the cardiovascular mortality over the 10-year period [@shumway_time_2006; @shumway_time_2017]. 


```{r}
#Correlation, scatter plots, and bivariate regression
df <- cbind(Particulates=part,
            Mortality=cmort,
            Temperature=tempr)
chart.Correlation(df)
```

Correlation matrix for the different time series. The diagonal displays the histogram and kernel density estimates of the variables. The lower off-diagonal shows the bivariate scatterplots with a lowess fitted line, and the upper off-diagonal shows the Pearsonâ€™s *R* coefficient with significance levels ($\cdot$ p < 0.1, ** p < 0.01, *** p < 0.001).


The scatterplots indicate a possible linear relation between mortality and the pollutant particulates, and between mortality and temperature. 


```{r}
plot(tempr, cmort, xlab="Temperature", ylab="Mortality")
lines(lowess(tempr, cmort))
```







# Modeling time series in R

```{r}
#Summary
summary(df)


#Center temperature
temp <- tempr-mean(tempr)
temp2 <- temp^2
trend <- time(cmort) # time

#Linear regression fit
summary(fit <- lm(cmort~ trend + temp + temp2 + part, na.action=NULL))

#ANOVA table (compare to next line)
summary(aov(fit)) 
summary(aov(lm(cmort~cbind(trend, temp, temp2, part)))) 


#AIC, BIC, AICc
num <- length(cmort) # sample size
AIC(fit)/num - log(2*pi) # AIC
BIC(fit)/num - log(2*pi) # BIC
(AICc <- log(sum(resid(fit)^2)/num) + (num+5)/(num-5-2)) #AiCc
```

We can relate mean adjusted temperature and particulate levels to cardiovascular mortality.



```{r}
#ACF
acf2(resid(fit), 52) # implies AR2
sarima(cmort, 2,0,0, xreg=cbind(trend,temp,temp2,part))
```

We assume that the current value at time *t* is white noise temporarily. The sample ACF and partial ACF (PACF) of
the residuals from the ordinary least squares fit of the model. The residual analysis output from `sarima` shows no obvious departure of the residuals from white noise.


# References










